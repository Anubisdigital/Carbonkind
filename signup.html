
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonKind - Account Access</title>
    <link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css">
    <style>
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        
        body {
            background: linear-gradient(135deg, #0A433A, #1B5E20, #33691E);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #F1F8E9;
            margin: 0;
            scroll-behavior: smooth;
        }
        
        .auth-section {
            width: 100%;
            max-width: 450px;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            margin: 20px;
        }
        
        h1 {
            font-size: 2.4rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg,#4CAF50,#FFC107);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Username System Styles */
        #username-setup {
            display: none;
            margin-top: 20px;
            text-align: left;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-group { position: relative; margin-bottom: 15px; }

        #usernameInput {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #ccc;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 1rem;
            outline: none;
        }

        #usernameInput.valid { border-color: #4CAF50; box-shadow: 0 0 10px rgba(76,175,80,0.5); }
        #usernameInput.invalid { border-color: #f44336; }

        .status-msg { font-size: 0.85rem; margin-top: 5px; font-weight: bold; }
        .status-msg.green { color: #81C784; }
        .status-msg.red { color: #E57373; }

        .suggestions {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .suggestion-item {
            display: block;
            padding: 8px;
            margin: 4px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            color: #C8E6C9;
        }

        .suggestion-item:hover { background: rgba(76,175,80,0.3); }

        #finishBtn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        #finishBtn:disabled { background: #555; cursor: not-allowed; }
        
        #loginBtn {
            margin-top: 20px;
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: background 0.3s;
        }
        
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            display: none;
            z-index: 1000;
        }
        #toast.success { background: #4CAF50; }
        #toast.error { background: #d32f2f; }
    </style>
</head>
<body>

<section class="auth-section" id="main-card">
    <h1>CarbonKind</h1>
    <div id="auth-ui-wrapper">
        <p>Sign in to continue</p>
        <div id="firebaseui-auth-container"></div>
        <button id="loginBtn">Login</button>
    </div>

    <div id="username-setup">
        <h3>Choose your Unique Name</h3>
        <p style="font-size: 0.9rem; opacity: 0.8;">This is the final step to secure your account.</p>
        
        <div class="input-group">
            <input type="text" id="usernameInput" placeholder="Enter username..." autocomplete="off">
            <div id="statusMsg" class="status-msg"></div>
        </div>

        <div id="suggestionBox" style="display:none;">
            <p style="font-size: 0.8rem; margin-bottom: 5px;">Taken! Try one of these:</p>
            <div class="suggestions" id="suggestionsList"></div>
        </div>

        <button id="finishBtn" disabled>Finish Sign Up</button>
    </div>
</section>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
firebase.initializeApp({
    apiKey: "AIzaSyD-YxRrtWHA4wEZc0_zTzoYhK4S5cJOJ34",
    authDomain: "watchbase-d25ad.firebaseapp.com",
    projectId: "watchbase-d25ad",
    appId: "1:209882344898:web:212ed39d768a112d727a5b"
});

const auth = firebase.auth();
let currentUser = null;

/* ================= SIMULATED TAKEN NAMES ================= */
// In a real app, you'd check your database here
const takenUsernames = ["admin", "earth", "nature", "green", "carbon", "Hack.V", "test.G"];

/* ================= TOAST ================= */
function showToast(msg, type) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.className = type;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
}

/* ================= USERNAME LOGIC ================= */
const usernameInput = document.getElementById('usernameInput');
const statusMsg = document.getElementById('statusMsg');
const suggestionBox = document.getElementById('suggestionBox');
const suggestionsList = document.getElementById('suggestionsList');
const finishBtn = document.getElementById('finishBtn');

usernameInput.addEventListener('input', () => {
    validateUsername(usernameInput.value);
});

function validateUsername(name) {
    if (name.length < 2) {
        statusMsg.textContent = "";
        finishBtn.disabled = true;
        usernameInput.classList.remove('valid', 'invalid');
        return;
    }

    if (takenUsernames.includes(name)) {
        usernameInput.classList.add('invalid');
        usernameInput.classList.remove('valid');
        statusMsg.textContent = "Username already exists";
        statusMsg.className = "status-msg red";
        finishBtn.disabled = true;
        generateSuggestions(name);
    } else {
        usernameInput.classList.add('valid');
        usernameInput.classList.remove('invalid');
        statusMsg.textContent = "Username is available!";
        statusMsg.className = "status-msg green";
        suggestionBox.style.display = "none";
        finishBtn.disabled = false;
    }
}

function generateSuggestions(name) {
    let suggestions = [];
    const suffixes = [".env", ".nature", ".guard", ".carbon", ".kind"];
    const sym = ["_", ".", "-"];
    
    // #1 & #2 Logic: s/z swap and two-name logic
    let base = name;
    if (name.toLowerCase().endsWith('s')) {
        base = name.slice(0, -1) + 'z';
    } else if (name.toLowerCase().endsWith('z')) {
        base = name.slice(0, -1) + 's';
    } else if (name.includes(" ")) {
        let parts = name.split(" ");
        base = parts[0] + "." + parts[1].charAt(0).toUpperCase();
    } else {
        base = name + "X"; // Creative alt if no s/z or space
    }

    // Add variations
    suggestions.push(base); 
    suggestions.push(name + suffixes[Math.floor(Math.random() * suffixes.length)]);
    suggestions.push(name + Math.floor(10 + Math.random() * 90)); // 2 numbers
    suggestions.push(name + Math.floor(100 + Math.random() * 899)); // 3 numbers
    suggestions.push(name + sym[Math.floor(Math.random() * sym.length)] + "seed");

    suggestionsList.innerHTML = "";
    suggestions.forEach(s => {
        const div = document.createElement('div');
        div.className = "suggestion-item";
        div.textContent = s;
        div.onclick = () => selectSuggestion(s);
        suggestionsList.appendChild(div);
    });
    suggestionBox.style.display = "block";
}

function selectSuggestion(name) {
    usernameInput.value = name;
    window.scrollTo(0, 0); // Scroll up to see input
    validateUsername(name); // Check if suggestion is also taken (Recursive check)
}

/* ================= FIREBASE UI ================= */
const ui = new firebaseui.auth.AuthUI(auth);

function startUsernamePhase(user) {
    currentUser = user;
    document.getElementById('auth-ui-wrapper').style.display = 'none';
    document.getElementById('username-setup').style.display = 'block';
    
    // Pre-fill with email prefix
    if (!usernameInput.value) {
        usernameInput.value = user.email.split('@')[0];
        validateUsername(usernameInput.value);
    }
}

ui.start("#firebaseui-auth-container", {
    signInFlow: "popup",
    signInOptions: [
        firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        firebase.auth.EmailAuthProvider.PROVIDER_ID
    ],
    callbacks: {
        signInSuccessWithAuthResult: function(authResult) {
            startUsernamePhase(authResult.user);
            return false; 
        }
    }
});

finishBtn.onclick = () => {
    const finalName = usernameInput.value;
    currentUser.updateProfile({ displayName: finalName }).then(() => {
        showToast("Profile Updated!", "success");
        setTimeout(() => window.location.href = "paper8.html", 1000);
    });
};

/* ================= MANUAL LOGIN ================= */
document.getElementById("loginBtn").addEventListener("click", () => {
    showToast("Please use the sign-in options above", "error");
});

// If already logged in but no display name, trigger username phase
auth.onAuthStateChanged(user => {
    if (user) {
        if (!user.displayName) {
            startUsernamePhase(user);
        } else {
            window.location.href = "paper8.html";
        }
    }
});
</script>
</body>
</html>
